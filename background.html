<html>
    <script type="text/javascript" src="rilList.js"></script>
	<script>
	
    chrome.contextMenus.create({"title": "I'll Read it Later ", "onclick": iwillril,"contexts":["page", "link"]});
	
	function post(url, params, callback){
		var xhr = new XMLHttpRequest();
		xhr.open("POST", url, true);   
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.onreadystatechange = function(){
		 callback(xhr.responseText);		  
		}
		xhr.send(params);	
	}
	
	function iwillril(info, tab){
	    
	    if(info.linkUrl && info.linkUrl.length > 0)
	        add(iwillril_callback, info.linkUrl,info.linkUrl);
        else
        {
            chrome.tabs.getSelected(null, function(tab) {
	        var url = tab.url;
	        var title = tab.title;
	        add(iwillril_callback, url,title);        
	        });
	    }
	}
	
	function iwillril_callback(resp){
	    update();
	}
	
	function is_authenticate(callback){
		var url = "https://readitlaterlist.com/v2/auth";
		var params = 	"username="+localStorage["rilName"]+
				"&password="+localStorage["rilPassword"]+
				"&apikey=158guBdkp52ePOcF54T3c16Qf2Akl517";
				
		post(url, params, callback);
		ril_auth();
	}
	
	function ril_auth(){
		var url = "http://readitlaterlist.com/login_process";
		var params = 	"feed_id="+localStorage["rilName"]+
				"&password="+localStorage["rilPassword"];	
				
		var xhr = new XMLHttpRequest();
		xhr.open("POST", url, false);   
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.setRequestHeader("Content-length", params.length);
		xhr.setRequestHeader("Connection", "close");			
		var teste = chrome.extension.getViews()[0];

		xhr.send(params);
		xhr.responseText;	
	}
		
	function add(callback, addurl, title){
		var url = "https://readitlaterlist.com/v2/add";
		var params =	"username="+localStorage["rilName"]+
				"&password="+localStorage["rilPassword"]+
				"&apikey=158guBdkp52ePOcF54T3c16Qf2Akl517"+
				"&url="+addurl+
				"&title="+title+
				"&tags=testando";
					  
		post(url, params, callback);		
	}
		

	function get(callback, time){
		var url = "https://readitlaterlist.com/v2/get";
		var params ="password="+localStorage["rilPassword"]+
				"&apikey=158guBdkp52ePOcF54T3c16Qf2Akl517"+
				"&username="+localStorage["rilName"]+
				"&since="+time+
				"&tags=0"+
				"&state=\"0\"";				

		post(url, params, callback);		
	}
		
	function send(callback, read_list){
		var url = "https://readitlaterlist.com/v2/send";
		var params = 	"username="+localStorage["rilName"]+
			    	"&password="+localStorage["rilPassword"]+
				"&apikey=158guBdkp52ePOcF54T3c16Qf2Akl517";
					
		params += make_send_param(read_list);		
		post(url, params, callback);		
	}
	
	function get_uncount_number(callback){
		stats(callback);
	}
	
	function stats(callback){
	
		var url = "https://readitlaterlist.com/v2/stats";
		var params = 	"username="+localStorage["rilName"]+
			    	"&password="+localStorage["rilPassword"]+
				"&apikey=158guBdkp52ePOcF54T3c16Qf2Akl517";
		
		post(url, params, callback);
	}
	
	function replaceAll(str, token, newtoken){
    var str_array = new Array();
    str_array = str.split(token);
    var new_str = '';
    for(var i = 0; i < str_array.length; i++) {
      if(new_str == '')
        new_str = str_array[i];
      else
        new_str = new_str + newtoken + str_array[i];
    }   
    return new_str;
	}
		
	function make_send_param(list){
		var params = "";
		for(var i = 0; i < list.length; i++){
		    var url = escape(list[i]);
		    url= replaceAll(url, "&", "%26amp;");		  
		    url= replaceAll(url, "+", "%2B");
			  params = params +  "\""+ i + "\":{" + "\"url\":\""+ url + "\"" + "},"; 		               
		}
		  
		if(params.length > 0){
			params = params.substr(0, params.length - 1);
			params = "&read={"+params+"}";
		}
		return params;
	}
		
	function add_2_ril(){
		
	}
	
	function _add_callback(resp){
		resp;		
	}
	
    function update_loop(){
        var interval = 1000 * 60 * 30;//30 minutos
        setInterval(update, interval);
     }
	
	function update(){
	  get(update_content, 0);
	}
	
	//Recebe a resposta do ReadItLater e guarda os favicon e lista
  function update_content(resp){  
    localStorage["json_list_iwillril"] = resp; 
    var list = RilList.parse_2jsonOK(resp);	  
    list = RilList.parse_json2obj(list);
    
    if(list.length > 0){
            if(localStorage['iwillril_order_by'] == "new")
                list.sort(RilList.sort_function_new);
            else
                list.sort(RilList.sort_function_old);
			var favicons = new Array();	
			var list_items = new Array();
			var list_content = "";		 
			
			for(var i = 0; i < list.length; i++){
				var obj = list[i];
				list_items[i]= build_item_table(i, obj.title, obj.url);
				favicons[i] = get_domain(obj.url)+"/favicon.ico";
			}      
				
      localStorage["ril_mylist_array"]  = list_items.join("||||");
			localStorage["favicons"] = favicons.join("||||");
		}
		else{
		  localStorage["ril_mylist_array"]  = "";
		}
  }		
    
  function build_item_table(i, real_title, url){
    var title = real_title;
    if(title.length > 40)
    title = title.substr(0, 40) + "...";
    var item =  "<tr onmouseover=\"change_line_style('over', this);\" onmouseout=\"change_line_style('out', this);\" id=\"line_index_"+i+"\" >"+
                    "<td class=\"no_border\">"+
                        "<span><img id=\"favicon_index_"+i+"\" class=\"favicon\"></img></span>"+
                    "</td>"+
                    "<td nowrap='nowrap'>"+
                        "<span id=\"title_span_index_"+i+"\" onmouseout=\"change_title_style('"+i+"', 'off')\" onmouseover=\"change_title_style('"+i+"', 'on')\">"+
	                        "<a href=\""+url+"\" target=\"_blank\" title=\""+real_title+"\">"+title+"</a>"+
	                    "</span>"+
	                    "<br><label class=\"url_domain\">"+get_domain(url)+"</label>"+
                    "</td>"+
                    "<td class=\"no_border\">"+
                        "<span class=\"list_span\" id=\"list_img_index_"+i+"\"  onclick=\"mark_as_read('"+url+"', "+i+")\">"+
	                        "<img onmouseover=\"change_mark_as_read_style('over', this);\" onmouseout=\"change_mark_as_read_style('out', this);\"  title=\"Mark as Read\" id=\"img_line_index"+i+"\" src='check.png'>"+
                        "</span>"+
                    "</td>" +
/*                     "<td class=\"no_border\">"+
                        "<span class=\"list_span\" id=\"list_img_index_"+i+"\" onclick=\"add_to_delicious('"+url+"', '" + real_title + "' )\">"+
	                        "<img  title=\"Add To Delicious\" id=\"img_line_index"+i+"\" src='delicious.png'>"+
                        "</span>"+
                    "</td>"+
*/                    
                "</tr>";
	return item;
}


  function get_domain(url){
	  url = url.replace(/https?/,"");
	  url = url.replace("://", "");
	  var index = url.indexOf("/");
	  url = "http://" + url.substr(0, index);
	  if(url.length > 30)
        url = url.substr(0, 30) + "...";
	  return url;
  }
		
	</script>	
</html>
